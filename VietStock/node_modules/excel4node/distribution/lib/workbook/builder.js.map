{"version":3,"sources":["../../../source/lib/workbook/builder.js"],"names":["xmlbuilder","require","JSZip","fs","CTColor","utils","addRootContentTypesXML","promiseObj","Promise","resolve","reject","xml","create","att","contentTypesAdded","extensionsAdded","wb","sheets","forEach","s","i","drawingCollection","length","drawings","d","indexOf","extension","typeRef","contentType","ele","push","sheetId","xmlString","doc","end","xmlOutVars","xlsx","file","addRootRelsXML","folder","addWorkbookXML","booksViewEle","workbookViewEle","opts","workbookView","viewOpts","activeTab","autoFilterDateGrouping","boolToInt","firstSheet","minimized","showHorizontalScroll","showSheetTabs","showVerticalScroll","tabRatio","visibility","windowWidth","windowHeight","xWindow","yWindow","sheetsEle","sheet","name","hidden","printArea","startCellRef","getExcelAlpha","startCol","startRow","endCellRef","endCol","endRow","definedNameCollection","addDefinedName","localSheetId","refFormula","isEmpty","addToXMLele","addWorkbookRelsXML","addWorksheetsXML","curSheet","processNextSheet","thisSheet","generateXML","then","generateRelsXML","catch","e","logger","error","stack","addSharedStringsXML","sharedStrings","txt","Array","thisSI","theseRuns","currProps","curRun","undefined","props","text","Object","keys","k","value","run","thisRun","thisRunProps","bold","italics","strike","outline","shadow","condense","extend","color","thisColor","size","underline","vertAlign","addStylesXML","styleData","numFmts","nfXML","nf","fontXML","fonts","f","fillXML","fills","fXML","borderXML","borders","b","cellXfsXML","styles","addXFtoXMLele","dxfCollection","addDrawingsXML","mediaCollection","ws","drawingRelXML","drawingsXML","kind","target","id","image","imagePath","readFileSync","rId","type","drawingsXMLStr","drawingRelXMLStr","writeToBuffer","Worksheet","jszip","generateAsync","buf","workbookXML","result","files","_data","module","exports"],"mappings":"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","file":"builder.js","sourcesContent":["const xmlbuilder = require('xmlbuilder');\nconst JSZip = require('jszip');\nconst fs = require('fs');\nconst CTColor = require('../style/classes/ctColor.js');\nconst utils = require('../utils');\n\nlet addRootContentTypesXML = (promiseObj) => {\n  // Required as stated in §12.2\n  return new Promise((resolve, reject) => {\n    let xml = xmlbuilder.create(\n        'Types', {\n          'version': '1.0',\n          'encoding': 'UTF-8',\n          'standalone': true,\n          'allowSurrogateChars': true\n        }\n      )\n      .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/content-types');\n\n    let contentTypesAdded = [];\n    let extensionsAdded = [];\n    promiseObj.wb.sheets.forEach((s, i) => {\n      if (s.drawingCollection.length > 0) {\n        s.drawingCollection.drawings.forEach((d) => {\n          if (extensionsAdded.indexOf(d.extension) < 0) {\n            let typeRef = d.contentType + '.' + d.extension;\n            if (contentTypesAdded.indexOf(typeRef) < 0) {\n              xml.ele('Default').att('ContentType', d.contentType).att('Extension', d.extension);\n            }\n            extensionsAdded.push(d.extension);\n          }\n        });\n      }\n    });\n    xml.ele('Default').att('ContentType', 'application/xml').att('Extension', 'xml');\n    xml.ele('Default').att('ContentType', 'application/vnd.openxmlformats-package.relationships+xml').att('Extension', 'rels');\n    xml.ele('Override').att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml').att('PartName', '/xl/workbook.xml');\n    promiseObj.wb.sheets.forEach((s, i) => {\n      xml.ele('Override')\n        .att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml')\n        .att('PartName', `/xl/worksheets/sheet${i + 1}.xml`);\n\n      if (s.drawingCollection.length > 0) {\n        xml.ele('Override')\n          .att('ContentType', 'application/vnd.openxmlformats-officedocument.drawing+xml')\n          .att('PartName', '/xl/drawings/drawing' + s.sheetId + '.xml');\n      }\n    });\n    xml.ele('Override').att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml').att('PartName', '/xl/styles.xml');\n    xml.ele('Override').att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml').att('PartName', '/xl/sharedStrings.xml');\n\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n    promiseObj.xlsx.file('[Content_Types].xml', xmlString);\n    resolve(promiseObj);\n  });\n};\n\nlet addRootRelsXML = (promiseObj) => {\n  // Required as stated in §12.2\n  return new Promise((resolve, reject) => {\n    let xml = xmlbuilder.create(\n        'Relationships', {\n          'version': '1.0',\n          'encoding': 'UTF-8',\n          'standalone': true,\n          'allowSurrogateChars': true\n        }\n      )\n      .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\n\n    xml\n      .ele('Relationship')\n      .att('Id', 'rId1')\n      .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument')\n      .att('Target', 'xl/workbook.xml');\n\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n    promiseObj.xlsx.folder('_rels').file('.rels', xmlString);\n    resolve(promiseObj);\n\n  });\n};\n\nlet addWorkbookXML = (promiseObj) => {\n  // Required as stated in §12.2\n  return new Promise((resolve, reject) => {\n\n    let xml = xmlbuilder.create(\n      'workbook', {\n        'version': '1.0',\n        'encoding': 'UTF-8',\n        'standalone': true,\n        'allowSurrogateChars': true\n      }\n    );\n    xml.att('mc:Ignorable', 'x15');\n    xml.att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main');\n    xml.att('xmlns:mc', 'http://schemas.openxmlformats.org/markup-compatibility/2006');\n    xml.att('xmlns:r', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships');\n    xml.att('xmlns:x15', 'http://schemas.microsoft.com/office/spreadsheetml/2010/11/main');\n\n    let booksViewEle = xml.ele('bookViews');\n    let workbookViewEle = booksViewEle.ele('workbookView');\n    // bookViews (§18.2.1)\n    if (promiseObj.wb.opts.workbookView) {\n      const viewOpts = promiseObj.wb.opts.workbookView;\n      if (viewOpts.activeTab) {\n        workbookViewEle.att('activeTab', viewOpts.activeTab);\n      }\n      if (viewOpts.autoFilterDateGrouping) {\n        workbookViewEle.att('autoFilterDateGrouping', utils.boolToInt(viewOpts.autoFilterDateGrouping));\n      }\n      if (viewOpts.firstSheet) {\n        workbookViewEle.att('firstSheet', viewOpts.firstSheet);\n      }\n      if (viewOpts.minimized) {\n        workbookViewEle.att('minimized', utils.boolToInt(viewOpts.minimized));\n      }\n      if (viewOpts.showHorizontalScroll) {\n        workbookViewEle.att('showHorizontalScroll', utils.boolToInt(viewOpts.showHorizontalScroll));\n      }\n      if (viewOpts.showSheetTabs) {\n        workbookViewEle.att('showSheetTabs', utils.boolToInt(viewOpts.showSheetTabs));\n      }\n      if (viewOpts.showVerticalScroll) {\n        workbookViewEle.att('showVerticalScroll', utils.boolToInt(viewOpts.showVerticalScroll));\n      }\n      if (viewOpts.tabRatio) {\n        workbookViewEle.att('tabRatio', viewOpts.tabRatio);\n      }\n      if (viewOpts.visibility) {\n        workbookViewEle.att('visibility', viewOpts.visibility);\n      }\n      if (viewOpts.windowWidth) {\n        workbookViewEle.att('windowWidth', viewOpts.windowWidth);\n      }\n      if (viewOpts.windowHeight) {\n        workbookViewEle.att('windowHeight', viewOpts.windowHeight);\n      }\n      if (viewOpts.xWindow) {\n        workbookViewEle.att('xWindow', viewOpts.xWindow);\n      }\n      if (viewOpts.yWindow) {\n        workbookViewEle.att('yWindow', viewOpts.yWindow);\n      }\n    }\n\n    let sheetsEle = xml.ele('sheets');\n    promiseObj.wb.sheets.forEach((s, i) => {\n      const sheet = sheetsEle.ele('sheet')\n        .att('name', s.name)\n        .att('sheetId', i + 1)\n        .att('r:id', `rId${i + 1}`);\n\n      if (s.opts.hidden) {\n        sheet.att('state', 'hidden');\n      }\n\n      if (s.printArea) {\n        const name = s.name;\n        const startCellRef = `$${utils.getExcelAlpha(s.printArea.startCol)}$${s.printArea.startRow}`;\n        const endCellRef = `$${utils.getExcelAlpha(s.printArea.endCol)}$${s.printArea.endRow}`;\n        s.wb.definedNameCollection.addDefinedName({\n          name: '_xlnm.Print_Area',\n          localSheetId: s.localSheetId,\n          refFormula: `'${name}'!${startCellRef}:${endCellRef}`,\n        });\n      }\n    });\n\n    if (!promiseObj.wb.definedNameCollection.isEmpty) {\n      promiseObj.wb.definedNameCollection.addToXMLele(xml);\n    }\n\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n    promiseObj.xlsx.folder('xl').file('workbook.xml', xmlString);\n    resolve(promiseObj);\n\n  });\n};\n\nlet addWorkbookRelsXML = (promiseObj) => {\n  // Required as stated in §12.2\n  return new Promise((resolve, reject) => {\n\n    let xml = xmlbuilder.create(\n        'Relationships', {\n          'version': '1.0',\n          'encoding': 'UTF-8',\n          'standalone': true,\n          'allowSurrogateChars': true\n        }\n      )\n      .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\n\n    xml\n      .ele('Relationship')\n      .att('Id', `rId${promiseObj.wb.sheets.length + 1}`)\n      .att('Target', 'sharedStrings.xml')\n      .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings');\n\n    xml\n      .ele('Relationship')\n      .att('Id', `rId${promiseObj.wb.sheets.length + 2}`)\n      .att('Target', 'styles.xml')\n      .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles');\n\n    promiseObj.wb.sheets.forEach((s, i) => {\n      xml\n        .ele('Relationship')\n        .att('Id', `rId${i + 1}`)\n        .att('Target', `worksheets/sheet${i + 1}.xml`)\n        .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet');\n    });\n\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n    promiseObj.xlsx.folder('xl').folder('_rels').file('workbook.xml.rels', xmlString);\n    resolve(promiseObj);\n\n  });\n};\n\nlet addWorksheetsXML = (promiseObj) => {\n  // Required as stated in §12.2\n  return new Promise((resolve, reject) => {\n\n    let curSheet = 0;\n\n    let processNextSheet = () => {\n      let thisSheet = promiseObj.wb.sheets[curSheet];\n      if (thisSheet) {\n        curSheet++;\n        thisSheet.generateXML()\n          .then((xml) => {\n            return new Promise((resolve) => {\n              // Add worksheet to zip\n              promiseObj.xlsx.folder('xl').folder('worksheets').file(`sheet${curSheet}.xml`, xml);\n\n              resolve();\n            });\n          })\n          .then(() => {\n            return thisSheet.generateRelsXML();\n          })\n          .then((xml) => {\n            return new Promise((resolve) => {\n              if (xml) {\n                promiseObj.xlsx.folder('xl').folder('worksheets').folder('_rels').file(`sheet${curSheet}.xml.rels`, xml);\n              }\n              resolve();\n            });\n          })\n          .then(processNextSheet)\n          .catch((e) => {\n            promiseObj.wb.logger.error(e.stack);\n          });\n      } else {\n        resolve(promiseObj);\n      }\n    };\n    processNextSheet();\n\n  });\n};\n\n/**\n * Generate XML for SharedStrings.xml file and add it to zip file. Called from _writeToBuffer()\n * @private\n * @memberof Workbook\n * @param {Object} promiseObj object containing jszip instance, workbook intance and xmlvars\n * @return {Promise} Resolves with promiseObj\n */\nlet addSharedStringsXML = (promiseObj) => {\n  // §12.3.15 Shared String Table Part\n  return new Promise((resolve, reject) => {\n\n    let xml = xmlbuilder.create(\n        'sst', {\n          'version': '1.0',\n          'encoding': 'UTF-8',\n          'standalone': true,\n          'allowSurrogateChars': true\n        }\n      )\n      .att('count', promiseObj.wb.sharedStrings.length)\n      .att('uniqueCount', promiseObj.wb.sharedStrings.length)\n      .att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main');\n\n    promiseObj.wb.sharedStrings.forEach((s) => {\n      if (typeof s === 'string') {\n        xml.ele('si').ele('t').txt(s);\n      } else if (s instanceof Array) {\n\n        let thisSI = xml.ele('si');\n        let theseRuns = []; // §18.4.4 r (Rich Text Run)\n        let currProps = {};\n        let curRun;\n        let i = 0;\n        while (i < s.length) {\n          if (typeof s[i] === 'string') {\n            if (curRun === undefined) {\n              theseRuns.push({\n                props: {},\n                text: ''\n              });\n              curRun = theseRuns[theseRuns.length - 1];\n            }\n            curRun.text = curRun.text + s[i];\n          } else if (typeof s[i] === 'object') {\n            theseRuns.push({\n              props: {},\n              text: ''\n            });\n            curRun = theseRuns[theseRuns.length - 1];\n            Object.keys(s[i]).forEach((k) => {\n              currProps[k] = s[i][k];\n            });\n            Object.keys(currProps).forEach((k) => {\n              curRun.props[k] = currProps[k];\n            });\n            if (s[i].value !== undefined) {\n              curRun.text = s[i].value;\n            }\n          }\n          i++;\n        }\n\n        theseRuns.forEach((run) => {\n          if (Object.keys(run).length < 1) {\n            thisSI.ele('t', run.text).att('xml:space', 'preserve');\n          } else {\n            let thisRun = thisSI.ele('r');\n            let thisRunProps = thisRun.ele('rPr');\n            typeof run.props.name === 'string' ? thisRunProps.ele('rFont').att('val', run.props.name) : null;\n            run.props.bold === true ? thisRunProps.ele('b') : null;\n            run.props.italics === true ? thisRunProps.ele('i') : null;\n            run.props.strike === true ? thisRunProps.ele('strike') : null;\n            run.props.outline === true ? thisRunProps.ele('outline') : null;\n            run.props.shadow === true ? thisRunProps.ele('shadow') : null;\n            run.props.condense === true ? thisRunProps.ele('condense') : null;\n            run.props.extend === true ? thisRunProps.ele('extend') : null;\n            if (typeof run.props.color === 'string') {\n              let thisColor = new CTColor(run.props.color);\n              thisColor.addToXMLele(thisRunProps);\n            }\n            typeof run.props.size === 'number' ? thisRunProps.ele('sz').att('val', run.props.size) : null;\n            run.props.underline === true ? thisRunProps.ele('u') : null;\n            typeof run.props.vertAlign === 'string' ? thisRunProps.ele('vertAlign').att('val', run.props.vertAlign) : null;\n            thisRun.ele('t', run.text).att('xml:space', 'preserve');\n          }\n        });\n\n      }\n    });\n\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n    promiseObj.xlsx.folder('xl').file('sharedStrings.xml', xmlString);\n\n    resolve(promiseObj);\n\n  });\n};\n\nlet addStylesXML = (promiseObj) => {\n  // §12.3.20 Styles Part\n  return new Promise((resolve, reject) => {\n\n    let xml = xmlbuilder.create(\n        'styleSheet', {\n          'version': '1.0',\n          'encoding': 'UTF-8',\n          'standalone': true,\n          'allowSurrogateChars': true\n        }\n      )\n      .att('mc:Ignorable', 'x14ac')\n      .att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main')\n      .att('xmlns:mc', 'http://schemas.openxmlformats.org/markup-compatibility/2006')\n      .att('xmlns:x14ac', 'http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac');\n\n    if (promiseObj.wb.styleData.numFmts.length > 0) {\n      let nfXML = xml\n        .ele('numFmts')\n        .att('count', promiseObj.wb.styleData.numFmts.length);\n      promiseObj.wb.styleData.numFmts.forEach((nf) => {\n        nf.addToXMLele(nfXML);\n      });\n    }\n\n    let fontXML = xml\n      .ele('fonts')\n      .att('count', promiseObj.wb.styleData.fonts.length);\n    promiseObj.wb.styleData.fonts.forEach((f) => {\n      f.addToXMLele(fontXML);\n    });\n\n    let fillXML = xml\n      .ele('fills')\n      .att('count', promiseObj.wb.styleData.fills.length);\n    promiseObj.wb.styleData.fills.forEach((f) => {\n      let fXML = fillXML.ele('fill');\n      f.addToXMLele(fXML);\n    });\n\n    let borderXML = xml\n      .ele('borders')\n      .att('count', promiseObj.wb.styleData.borders.length);\n    promiseObj.wb.styleData.borders.forEach((b) => {\n      b.addToXMLele(borderXML);\n    });\n\n\n    let cellXfsXML = xml\n      .ele('cellXfs')\n      .att('count', promiseObj.wb.styles.length);\n    promiseObj.wb.styles.forEach((s) => {\n      s.addXFtoXMLele(cellXfsXML);\n    });\n\n    if (promiseObj.wb.dxfCollection.length > 0) {\n      promiseObj.wb.dxfCollection.addToXMLele(xml);\n    }\n\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\n    promiseObj.xlsx.folder('xl').file('styles.xml', xmlString);\n\n    resolve(promiseObj);\n  });\n};\n\nlet addDrawingsXML = (promiseObj) => {\n  return new Promise((resolve) => {\n    if (!promiseObj.wb.mediaCollection.isEmpty) {\n\n      promiseObj.wb.sheets.forEach((ws) => {\n        if (!ws.drawingCollection.isEmpty) {\n\n          let drawingRelXML = xmlbuilder.create('Relationships', {\n              'version': '1.0',\n              'encoding': 'UTF-8',\n              'standalone': true,\n              'allowSurrogateChars': true\n            })\n            .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\n\n          let drawingsXML = xmlbuilder.create(\n            'xdr:wsDr', {\n              'version': '1.0',\n              'encoding': 'UTF-8',\n              'standalone': true,\n              'allowSurrogateChars': true\n            }\n          );\n          drawingsXML\n            .att('xmlns:a', 'http://schemas.openxmlformats.org/drawingml/2006/main')\n            .att('xmlns:xdr', 'http://schemas.openxmlformats.org/drawingml/2006/spreadsheetDrawing');\n\n          ws.drawingCollection.drawings.forEach((d) => {\n\n            if (d.kind === 'image') {\n              let target = 'image' + d.id + '.' + d.extension;\n\n              let image = d.imagePath ? fs.readFileSync(d.imagePath) : d.image;\n              promiseObj.xlsx.folder('xl').folder('media').file(target, image);\n\n              drawingRelXML.ele('Relationship')\n                .att('Id', d.rId)\n                .att('Target', '../media/' + target)\n                .att('Type', d.type);\n\n            }\n\n\n\n            d.addToXMLele(drawingsXML);\n\n          });\n\n          let drawingsXMLStr = drawingsXML.doc().end(promiseObj.xmlOutVars);\n          let drawingRelXMLStr = drawingRelXML.doc().end(promiseObj.xmlOutVars);\n          promiseObj.xlsx.folder('xl').folder('drawings').file('drawing' + ws.sheetId + '.xml', drawingsXMLStr);\n          promiseObj.xlsx.folder('xl').folder('drawings').folder('_rels').file('drawing' + ws.sheetId + '.xml.rels', drawingRelXMLStr);\n        }\n      });\n\n    }\n    resolve(promiseObj);\n  });\n};\n\n/**\n * Use JSZip to generate file to a node buffer\n * @private\n * @memberof Workbook\n * @param {Workbook} wb Workbook instance\n * @return {Promise} resolves with Buffer\n */\nlet writeToBuffer = (wb) => {\n  return new Promise((resolve, reject) => {\n    let promiseObj = {\n      wb: wb,\n      xlsx: new JSZip(),\n      xmlOutVars: {}\n    };\n\n    if (promiseObj.wb.sheets.length === 0) {\n      promiseObj.wb.Worksheet();\n    }\n\n    addRootContentTypesXML(promiseObj)\n      .then(addWorksheetsXML)\n      .then(addRootRelsXML)\n      .then(addWorkbookXML)\n      .then(addWorkbookRelsXML)\n      .then(addSharedStringsXML)\n      .then(addStylesXML)\n      .then(addDrawingsXML)\n      .then(() => {\n        wb.opts.jszip.type = 'nodebuffer';\n        promiseObj.xlsx.generateAsync(wb.opts.jszip)\n          .then((buf) => {\n            resolve(buf);\n          })\n          .catch((e) => {\n            reject(e);\n          });\n      })\n      .catch((e) => {\n        reject(e);\n      });\n\n  });\n};\n\n/**\n * @desc Currently only used for testing the XML generated for a Workbook.\n * @param {*} wb Workbook instance\n * @return {Promise} resolves with Workbook XML\n */\nlet workbookXML = (wb) => {\n  let promiseObj = {\n    wb: wb,\n    xlsx: new JSZip(),\n    xmlOutVars: {}\n  };\n\n  return addWorkbookXML(promiseObj).then((result) => {\n    return result.xlsx.files['xl/workbook.xml']._data;\n  });\n}\n\nmodule.exports = {\n  writeToBuffer,\n  workbookXML\n};"]}